import streamlit as st
from transformers import pipeline
from utils import fetch_movies_by_genres, fetch_genres, generate_ai_poster
import random

# ------------------------------
# Streamlit Setup
# ------------------------------
st.set_page_config(page_title="MoodFlix 2.0 ğŸ¬", page_icon="ğŸ¥", layout="wide")
st.title("ğŸ¬ MoodFlix 2.0 â€“ Movies that Match Your Mood")

st.markdown("Describe your mood or what kind of movie you want ğŸ‘‡")

# ------------------------------
# Emotion Detection
# ------------------------------
emotion_model = pipeline("sentiment-analysis", model="j-hartmann/emotion-english-distilroberta-base")

user_input = st.text_input("Your mood / feeling:", placeholder="e.g. I feel happy and want something funny")

if not user_input:
Â Â Â Â st.info("Enter a mood or description above to get started.")
Â Â Â Â st.stop()

# Detect emotion
detected = emotion_model(user_input)
emotion = detected[0]["label"].lower()
st.markdown(f"**Detected Emotion:** ğŸ­ *{emotion.capitalize()}*")

# ------------------------------
# Emotion â†’ Genre Mapping
# ------------------------------
emotion_genre_map = {
Â Â Â Â "happy": ["comedy", "adventure", "romance"],
Â Â Â Â "sad": ["drama", "romance"],
Â Â Â Â "angry": ["action", "thriller"],
Â Â Â Â "bored": ["adventure", "fantasy"],
Â Â Â Â "excited": ["action", "sci-fi"],
Â Â Â Â "nostalgic": ["romance", "drama"],
Â Â Â Â "romantic": ["romance", "musical"]
}

genres = emotion_genre_map.get(emotion, ["drama", "adventure"])
st.write(f"Recommended genres: {', '.join(genres)}")

# ------------------------------
# TMDb Movie Fetching
# ------------------------------
genre_dict = fetch_genres()
genre_ids = [str(genre_dict.get(g.lower(), 18)) for g in genres]Â Â # fallback to drama if missing
movies = fetch_movies_by_genres(genre_ids)

if not movies:
Â Â Â Â st.error("No movies found for this mood. Try a different emotion.")
Â Â Â Â st.stop()

# ------------------------------
# Display Movies + AI Posters
# ------------------------------
st.markdown("---")
st.subheader(f"ğŸï¸ Top {min(5, len(movies))} Movies for a {emotion.capitalize()} Mood")

cols = st.columns(2)

for idx, movie in enumerate(random.sample(movies, k=min(5, len(movies)))):
Â Â Â Â title = movie.get("title", "Unknown Title")
Â Â Â Â overview = movie.get("overview", "No description available.")
Â Â Â Â genre = genres[0]

Â Â Â Â # AI Poster
Â Â Â Â with cols[idx % 2]:
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â poster_url = generate_ai_poster(title, genre, overview)
Â Â Â Â Â Â Â Â Â Â Â Â st.image(poster_url, caption=title, use_container_width=True)
Â Â Â Â Â Â Â Â except Exception:
Â Â Â Â Â Â Â Â Â Â Â Â if movie.get("poster_path"):
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â st.image(f"https://image.tmdb.org/t/p/w500{movie['poster_path']}", caption=title, use_container_width=True)
Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â st.warning("No poster available")

Â Â Â Â Â Â Â Â st.markdown(f"**ğŸ¬ {title}** â€“ *{genre.capitalize()}*")
Â Â Â Â Â Â Â Â st.write(overview)
Â Â Â Â Â Â Â Â st.markdown("---")
        

